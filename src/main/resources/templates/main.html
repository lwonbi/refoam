<html layout:decorate="~{layout}" lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<div class="container mb-5" layout:fragment="content">
    <h2 class="my-4">ì˜¤ëŠ˜ì˜ ë‹¬ì„±ë¥ </h2>
    <div class="row mb-5">
        <div class="col-12 col-lg-6">
            <p class="fs-5 archive-font text-center mt-lg-1 mt-md-3 mb-2">
                ì˜¤ëŠ˜ì˜ ëª©í‘œ ìˆ˜ëŸ‰: <span class="refoam-font fw-bold" id="targetCount" th:text="${targetQuantity}">0</span>ê°œ
            </p>
            <div class="tassei">
                <canvas id="achievementRate"></canvas>
            </div>
        </div>

        <div class="col-12 col-lg-6 ">
            <div class="mt-3"> </div>
            <div class="row gx-3 pt-md-4 pb-3 h-100">
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <p class="my-1">âœ…</p>
                            <h6 class="refoam-font mb-2 fw-bold">ë‹¬ì„± ìˆ˜ëŸ‰</h6>
                            <h6 class="gray-font mb-0" id="okCount" th:text="${okCount} + 'ê°œ'">0ê°œ</h6>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <p class="my-1">ğŸ“Š</p>
                            <h6 class="refoam-font mb-2 fw-bold">ë‹¬ì„±ë¥ </h6>
                            <h6 class="gray-font mb-0" id="achievementRateText" th:text="${achievementRate} + '%'">0%</h6>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <p class="my-1">ğŸ“¦</p>
                            <h6 class="refoam-font mb-2 fw-bold">ë‚¨ì€ ìˆ˜ëŸ‰</h6>
                            <h6 class="gray-font mb-0" id="remainingCount" th:text="${(targetQuantity != null and okCount != null) ? (targetQuantity - okCount) + 'ê°œ' : '0ê°œ'}">0ê°œ</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ê¸ˆí˜•ì˜¨ë„ -->
    <div class="my-4">
        <h2 class="mb-4">ê¸ˆí˜• ì˜¨ë„ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h2>
        <div class="container pe-0 ps-0">
            <div class="row justify-content-between gx-4 gy-4">
                <div class="col-12 col-lg-4">
                    <p class="gray-font fw-bold text-center">NORMAL</p>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartA"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <p class="gray-font fw-bold text-center">BUMP</p>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartB"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <p class="gray-font fw-bold text-center">HALF</p>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartC"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <h2 class="mb-4">ì œí’ˆë³„ ìƒì‚° í˜„í™©</h2>
    <div class="row align-content-center">
        <div class="col-12 col-lg-4 text-center mb-4">
            <div class="product-card card shadow-sm rounded-3 p-3">
                <canvas class="my-2 product-chart" id="chart-NORMAL"></canvas>
                <div class="my-2" id="count-NORMAL">ì •ìƒ: 0ê°œ / ë¶ˆëŸ‰: 0ê°œ</div>
            </div>
        </div>
        <div class="col-12 col-lg-4 text-center mb-4">
            <div class="product-card card shadow-sm rounded-3 p-3">
                <canvas class="my-2 product-chart" id="chart-BUMP"></canvas>
                <div class="my-2" id="count-BUMP">ì •ìƒ: 0ê°œ / ë¶ˆëŸ‰: 0ê°œ</div>
            </div>
        </div>
        <div class="col-12 col-lg-4 text-center">
            <div class="product-card card shadow-sm rounded-3 p-3">
                <canvas class="my-2 product-chart" id="chart-HALF"></canvas>
                <div class="my-2" id="count-HALF">ì •ìƒ: 0ê°œ / ë¶ˆëŸ‰: 0ê°œ</div>
            </div>
        </div>
    </div>
    <button id="showToastBtn" class="btn btn-refoam position-fixed bottom-0 end-0 m-4" style="z-index: 1100;">
        ğŸ“‹ ë¦¬í¬íŠ¸ ë³´ê¸°
    </button>
    <div class="position-fixed bottom-0 mb-5 end-0 p-3" style="z-index: 1100">
        <div id="aiReportToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="refoam-font me-auto">ğŸ“‹ AI ë¦¬í¬íŠ¸</strong>
                <small class="gray-font">ë°©ê¸ˆ ì „</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <span style="white-space: pre-line; margin-bottom: 0;" id="toastBody">AI ë¶„ì„ ë¦¬í¬íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
    </div>
    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ìˆœì„œ ì¤‘ìš” -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // jQuery ì¤‘ë³µ ë¡œë”© ì²´í¬
        if (typeof jQuery === 'undefined') {
            document.write('<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>');
        }
    </script>

    <!-- 2. Chart.js ê´€ë ¨ (ë ˆì´ì•„ì›ƒì—ì„œ ë¡œë”©ë˜ë¯€ë¡œ ì¡°ê±´ë¶€ ë¡œë”©) -->
    <script>
        // Chart.js ì¤‘ë³µ ë¡œë”© ì²´í¬
        if (typeof Chart === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>');
        }
    </script>

    <!-- 3. Chart.js í”ŒëŸ¬ê·¸ì¸ë“¤ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- 4. DevExtreme ê³„ê¸°íŒ -->
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.6/css/dx.light.css">
    <script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.all.js"></script>

    <!-- 5. WebSocket ê´€ë ¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- 6. ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript">
        // Chart.js CDN ëŒ€ì²´ ë¡œë”© ë¡œì§
        (function() {
            const cdnList = [
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js'
            ];

            let loaded = false;
            let currentIndex = 0;

            function loadNextCDN() {
                if (loaded || currentIndex >= cdnList.length) return;

                const script = document.createElement('script');
                script.src = cdnList[currentIndex];
                script.onload = function() {
                    loaded = true;
                    console.log('Chart.js ë¡œë“œ ì„±ê³µ:', cdnList[currentIndex]);
                };
                script.onerror = function() {
                    console.log('Chart.js ë¡œë“œ ì‹¤íŒ¨:', cdnList[currentIndex]);
                    currentIndex++;
                    loadNextCDN();
                };
                document.head.appendChild(script);
            }

            loadNextCDN();
        })();
    </script>

    <!-- 3. DevExtreme (ê²Œì´ì§€ìš©) -->
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.6/css/dx.light.css">
    <script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.all.js"></script>

    <!-- 4. WebSocket ê´€ë ¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- 5. ìˆ˜ì •ëœ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript">
        // ì „ì—­ ë³€ìˆ˜
        let temperatureCharts = [];
        let gaugeInstances = [];
        let stompClient = null;
        let isConnected = false;
        let achievementChart = null;
        let rate = /*[[${achievementRate}]]*/0;
        let target = /*[[${targetQuantity}]]*/0;
        let targetRate = /*[[${targetRate}]]*/0;

        // ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° í•¨ìˆ˜
        function waitForLibraries() {
            return new Promise((resolve) => {
                const checkLibraries = () => {
                    const jqueryReady = typeof $ !== 'undefined';
                    const chartReady = typeof Chart !== 'undefined';
                    const devExtremeReady = typeof DevExpress !== 'undefined';
                    const sockjsReady = typeof SockJS !== 'undefined';
                    const stompReady = typeof Stomp !== 'undefined';

                    if (jqueryReady && chartReady && devExtremeReady && sockjsReady && stompReady) {
                        resolve();
                    } else {
                        console.log('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ëŒ€ê¸° ì¤‘...', {
                            jquery: jqueryReady,
                            chart: chartReady,
                            devExtreme: devExtremeReady,
                            sockjs: sockjsReady,
                            stomp: stompReady
                        });
                        setTimeout(checkLibraries, 500);
                    }
                };
                checkLibraries();
            });
        }

        // DOM ì¤€ë¹„ í›„ ì‹¤í–‰
        $(document).ready(function() {
            console.log('DOM ë¡œë“œ ì™„ë£Œ');

            waitForLibraries().then(() => {
                console.log('ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
                initializeAll();
            }).catch(error => {
                console.error('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨:', error);
            });
        });

        function initializeAll() {
            try {
                initializeBasicCharts();
                initializeTemperatureCharts();
                initializeGauges();
                initializeWebSocketConnection();
                initializeToast();
                initializeProductChart();
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // ê¸°ë³¸ ì°¨íŠ¸ë“¤ (ì¬ê³ , ìƒì‚°ëŸ‰, ë‹¬ì„±ë¥ )
        function initializeBasicCharts() {
            console.log('ê¸°ë³¸ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘');

            const isAchieved = rate >= targetRate;
            const barColor = isAchieved ? "rgba(0, 200, 100, 0.7)" : "rgba(63, 0, 255, 0.7)";

            const achievementCtx = document.getElementById("achievementRate");
            if (!achievementCtx) return;

            if (!achievementChart) {
                // ì°¨íŠ¸ ìµœì´ˆ ìƒì„±
                achievementChart = new Chart(achievementCtx, {
                    type: "bar",
                    data: {
                        labels: ["ëª©í‘œ ë‹¬ì„±ë¥ "],
                        datasets: [{
                            label: "ì˜¤ëŠ˜ì˜ ë‹¬ì„±ë¥ ",
                            data: [rate],
                            backgroundColor: barColor,
                            borderWidth: 0,
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: "y",
                        scales: {
                            x: {
                                max: 100,
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return value + "%";
                                    },
                                },
                                title: {
                                    display: true,
                                    text: `(ëª©í‘œ: ${targetRate}%)`,
                                },
                            },
                            y: {
                                grid: { display: false },
                                ticks: { display: false },
                            },
                        },
                        plugins: {
                            legend: { display: true, position: "top" },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return "í˜„ì¬ ë‹¬ì„±ë¥ : " + context.raw + "%";
                                    },
                                },
                            },
                        },
                        animation: {
                            duration: 500 // ë¶€ë“œëŸ¬ìš´ ê°±ì‹ 
                        }
                    },
                });
            } else {
                // ê¸°ì¡´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                achievementChart.data.datasets[0].data = [rate];
                achievementChart.data.datasets[0].backgroundColor = barColor;
                achievementChart.options.scales.x.title.text = `(ëª©í‘œ: 80%)`;
                achievementChart.update();
            }

            console.log('ê¸°ë³¸ ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ì˜¨ë„ ë¼ì¸ ì°¨íŠ¸ ì´ˆê¸°í™” (WebSocket ë°ì´í„°ë§Œ ë°›ìŒ)
        function initializeTemperatureCharts() {
            console.log('ì˜¨ë„ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘');

            const HIGH_THRESHOLD = 81.8;
            const LOW_THRESHOLD = 80.6;
            const MAX_POINTS = 50;
            const names = ['NORMAL', 'BUMP', 'HALF'];
            const letters = ['A', 'B', 'C'];
            const colors = ['red', 'orange', 'blue'];

            temperatureCharts = letters.map((letter, i) => {
                const canvas = document.getElementById(`chart${letter}`);
                if (!canvas) {
                    console.warn(`Canvas chart${letter} not found`);
                    return null;
                }

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [], // ì‹œê°„ ë¬¸ìì—´ ë ˆì´ë¸”
                        datasets: [{
                            label: names[i],
                            data: [], // ì˜¨ë„ ê°’
                            borderWidth: 1.5,
                            fill: false,
                            borderColor: 'blue',
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            pointStyle: 'rectRot',
                            tension: 0.1,
                            pointBackgroundColor: function (context) {
                                const dataIndex = context.dataIndex;
                                const value = context.dataset.data[dataIndex];
                                if (typeof value === 'number') {
                                    if (value >= HIGH_THRESHOLD) return 'red';
                                    if (value <= LOW_THRESHOLD) return 'green';
                                }
                                return 'blue';
                            },
                            borderColor: function (context) {
                                if (context.type === 'dataset') {
                                    return 'blue';
                                }
                                const dataIndex = context.dataIndex;
                                const value = context.dataset.data[dataIndex];
                                if (typeof value === 'number') {
                                    if (value >= HIGH_THRESHOLD) return 'red';
                                    if (value <= LOW_THRESHOLD) return 'green';
                                }
                                return 'blue';
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {display: true, text: 'ì‹œê°„'},
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 8,
                                    callback: function (value, index, values) {
                                        const label = this.getLabelForValue(value);
                                        // HH:MM:SS í˜•ì‹ìœ¼ë¡œ í‘œì‹œ (ì´ˆê¹Œì§€ í¬í•¨)
                                        return label || '';
                                    }
                                }
                            },
                            y: {
                                suggestedMin: 80,
                                suggestedMax: 82,
                                title: {display: true, text: 'â„ƒ'}
                            }
                        },
                        plugins: {
                            legend: {display: true, position: 'top'},
                            tooltip: {
                                callbacks: {
                                    title: function (context) {
                                        return context[0].label;
                                    },
                                    label: function (context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}â„ƒ`;
                                    }
                                }
                            }
                        }
                    }
                });

                return chart;
            }).filter(chart => chart !== null);

            // 2. ì„œë²„ì—ì„œ ê³¼ê±° ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì°¨íŠ¸ ì´ˆê¸°í™”
            Promise.all(
                names.map((name, i) =>
                    fetch(`/api/temperature/${name}`)
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(data => {
                            console.log(`${name} ê³¼ê±° ë°ì´í„° ë¡œë“œ:`, data);

                            if (temperatureCharts[i]) {
                                const chart = temperatureCharts[i];

                                // ë°ì´í„° í˜•ì‹ì— ë”°ë¼ ì²˜ë¦¬
                                const dataArray = Array.isArray(data) ? data : [data];

                                dataArray.forEach(d => {
                                    if (d && d.time && typeof d.value === 'number') {
                                        // HH:MM:SS í˜•ì‹ìœ¼ë¡œ ì‹œê°„ ë ˆì´ë¸” ìƒì„±
                                        const timeLabel = new Date(d.time).toLocaleTimeString('ko-KR', {
                                            hour12: false,
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            second: '2-digit'
                                        });
                                        chart.data.labels.push(timeLabel);
                                        chart.data.datasets[0].data.push(d.value);
                                    }
                                });

                                // ìµœëŒ€ í¬ì¸íŠ¸ ìˆ˜ ì œí•œ
                                if (chart.data.labels.length > MAX_POINTS) {
                                    const excess = chart.data.labels.length - MAX_POINTS;
                                    chart.data.labels.splice(0, excess);
                                    chart.data.datasets[0].data.splice(0, excess);
                                }

                                chart.update();
                            }
                        })
                        .catch(error => {
                            console.warn(`${name} ê³¼ê±° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
                            // ê³¼ê±° ë°ì´í„°ê°€ ì—†ì–´ë„ ì‹¤ì‹œê°„ ë°ì´í„°ëŠ” ë°›ì„ ìˆ˜ ìˆë„ë¡ ê³„ì† ì§„í–‰
                        })
                )
            ).then(() => {
                console.log('ëª¨ë“  ê³¼ê±° ë°ì´í„° ë¡œë”© ì™„ë£Œ - WebSocket ì—°ê²° ì‹œì‘');
                // 3. ê³¼ê±° ë°ì´í„° ë¡œë”© ì™„ë£Œ í›„ WebSocket ì—°ê²°
                initializeWebSocketConnection();
            }).catch(error => {
                console.error('ê³¼ê±° ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                // ì˜¤ë¥˜ê°€ ìˆì–´ë„ WebSocketì€ ì—°ê²°
                initializeWebSocketConnection();
            });

            console.log('ì˜¨ë„ ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // WebSocket ì—°ê²° (ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ )
        function initializeWebSocketConnection() {
            console.log('WebSocket ì—°ê²° ì‹œì‘');

            if (typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
                console.error('WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }

            try {
                stompClient = Stomp.over(new SockJS('/ws'));
                stompClient.connect({}, function (frame) {
                    console.log('WebSocket ì—°ê²° ì„±ê³µ:', frame);
                    isConnected = true;

                    const names = ['NORMAL', 'BUMP', 'HALF'];
                    names.forEach((name, i) => {
                        // ì˜¨ë„ ë¼ì¸ ì°¨íŠ¸ êµ¬ë…
                        stompClient.subscribe(`/topic/temperature/${name}`, function (message) {
                            const value = parseFloat(message.body);
                            // HH:MM:SS í˜•ì‹ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ ìƒì„±
                            const timeStr = new Date().toLocaleTimeString('ko-KR', {
                                hour12: false,
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });

                            console.log(`ì‹¤ì‹œê°„ ì˜¨ë„ ë°ì´í„° ìˆ˜ì‹  ${name}:`, value);

                            // ë¼ì¸ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                            if (temperatureCharts[i]) {
                                const chart = temperatureCharts[i];

                                // ìƒˆ ë°ì´í„° ì¶”ê°€
                                chart.data.labels.push(timeStr);
                                chart.data.datasets[0].data.push(value);

                                // ìµœëŒ€ í¬ì¸íŠ¸ ìˆ˜ ì œí•œ (FIFO ë°©ì‹)
                                if (chart.data.labels.length > 10) {
                                    chart.data.labels.shift();
                                    chart.data.datasets[0].data.shift();
                                }

                                // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ë¹ ë¥´ê²Œ ì—…ë°ì´íŠ¸
                                chart.update('none');
                            }

                            // ê²Œì´ì§€ ì—…ë°ì´íŠ¸
                            if (gaugeInstances[i]) {
                                gaugeInstances[i].update(value);
                            }
                        });
                    });

                    let alreadySetTarget = false;
                    let previousOkCount = null;
                    let previousRate = null;

                    stompClient.subscribe('/topic/achievement', function (message) {
                        const data = JSON.parse(message.body);
                        console.log("ë‹¬ì„±ë¥  ë©”ì„¸ì§€ ìˆ˜ì‹ : ", data);

                        const newOkCount = data.okCount;
                        const newRate = parseFloat(data.achievementRate);

                        if (!alreadySetTarget) {
                            const targetText = document.getElementById("targetCount").innerText;
                            target = parseFloat(targetText.replace('ê°œ', '').trim());
                            alreadySetTarget = true;
                        }

                        const isUpdated = (previousOkCount !== newOkCount) || (previousRate !== newRate);

                        if (isUpdated) {
                            rate = newRate;
                            previousRate = newOkCount;
                            previousRate = newRate;
                        }

                        document.getElementById("okCount").innerText = data.okCount + 'ê°œ';
                        document.getElementById("achievementRateText").innerText = newRate + '%';

                        const remaining = target - newOkCount;
                        document.getElementById("remainingCount").innerText = remaining + 'ê°œ';

                        initializeBasicCharts();
                    });

                }, function (error) {
                    console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                    isConnected = false;

                    // ì¬ì—°ê²° ì‹œë„
                    setTimeout(() => {
                        console.log('WebSocket ì¬ì—°ê²° ì‹œë„...');
                        initializeWebSocketConnection();
                    }, 5000);
                });

            } catch (error) {
                console.error('WebSocket ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }


        // ê²Œì´ì§€ ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeGauges() {
            console.log('ê²Œì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

            class GaugeChart {
                constructor(el, {initialValue, higherValue, title, subtitle}) {
                    this._el = el;
                    this._initialValue = initialValue;
                    this._higherValue = higherValue;
                    this._title = title;
                    this._subtitle = subtitle;
                }

                _buildConfig() {
                    return {
                        rangeContainer: {
                            backgroundColor: '#ffffff',
                            width: 30,
                            ranges: [
                                {startValue: 80, endValue: 80.8, color: '#68e1a8'},
                                {startValue: 80.8, endValue: 81.4, color: '#4166f5'},
                                {startValue: 81.4, endValue: 81.6, color: '#ffc228'},
                                {startValue: 81.6, endValue: 82, color: '#ff8228'}
                            ]
                        },
                        valueIndicator: {
                            color: '#000',
                            // ë°”ëŠ˜ì˜ ì•ˆìª½ ëì„ ì¤‘ì‹¬ì—ì„œ -20px ë§Œí¼ ë” ë‹¹ê²¨ì„œ ê¸¸ê²Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
                            // ê¸°ë³¸ê°’ì€ 0ì´ë©°, ìŒìˆ˜ ê°’ì„ ì£¼ë©´ ë°”ëŠ˜ì´ ë” ê¸¸ì–´ì§‘ë‹ˆë‹¤.
                            indentFromCenter: -20,      // â—† ì—¬ê¸°ë¥¼ ì¡°ì ˆí•˜ì„¸ìš” :contentReference[oaicite:0]{index=0}
                            // ìŠ¤ì¼€ì¼ ë¼ì¸ ë°”ê¹¥ìœ¼ë¡œ ì–¼ë§ˆë‚˜ ë” ë°€ì–´ë‚¼ì§€ (ì„ íƒ)
                            offset: 0,
                            // ë°”ëŠ˜ ì¤‘ì•™ ìŠ¤í•€ë“¤(ì›)ì˜ ì§€ë¦„
                            spindleSize: 14,
                            // ì¤‘ì•™ ìŠ¤í•€ë“¤ì˜ êµ¬ë© í¬ê¸°(0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ë‚´ë¶€ê°€ ê½‰ ì°¹ë‹ˆë‹¤)
                            spindleGapSize: 0,
                            // (í•„ìš” ì‹œ) ë‹¤ë¥¸ í˜•íƒœì˜ ë°”ëŠ˜ì„ ì‚¬ìš©í•˜ê³  ì‹¶ìœ¼ë©´ type ì§€ì • ê°€ëŠ¥
                            // type: 'triangleMarker', length: 30
                            type: 'triangleNeedle'
                        },
                        geometry: {startAngle: 200, endAngle: 340},
                        scale: {
                            startValue: 80,
                            endValue: this._higherValue,
                            orientation: 'outside',
                            tick: {visible: true, length: 20, width: 1, color: '#000'},
                            tickInterval: 0.2,
                            minorTick: {visible: true, length: 5, width: 1, color: '#000'},
                            label: {font: {color: '#4c5156', size: 12}, indentFromTick: 15}
                        },
                        title: {
                            verticalAlignment: 'bottom',
                            text: this._title,
                            font: {
                                family: 'Noto Sans',   // ì œëª© í°íŠ¸ ë³€ê²½
                                size: 24,          // ì œëª© í°íŠ¸ í¬ê¸° ì¡°ì ˆ
                            }
                        },
                        value: this._initialValue
                    };
                }

                init() {
                    try {
                        this._gauge = $(this._el)
                            .dxCircularGauge(this._buildConfig())
                            .dxCircularGauge('instance');
                        console.log('ê²Œì´ì§€ ìƒì„± ì„±ê³µ:', this._subtitle);
                        return this;
                    } catch (error) {
                        console.error('ê²Œì´ì§€ ìƒì„± ì‹¤íŒ¨:', this._subtitle, error);
                        return null;
                    }
                }

                update(value) {
                    if (!this._gauge) return;
                    // â‘  ê°’ ê°±ì‹ 
                    this._gauge.option('value', value);
                    // â‘¡ ìƒ‰ìƒ ê²°ì •
                    let color = '#000';              // ê¸°ë³¸ ê²€ì •
                    if (value > 81.8) {
                        color = 'red';                 // ì„ê³„ ìƒí–¥ ëŒíŒŒ ì‹œ ë¹¨ê°•
                    } else if(value >= 81.4 && value <= 81.8) {
                        color = '#ff8228';
                    }
                    else if (value < 80.6) {
                        color = 'green';               // ì„ê³„ í•˜í–¥ ëŒíŒŒ ì‹œ ì´ˆë¡
                    }
                    // â‘¢ í…ìŠ¤íŠ¸ì™€ ìƒ‰ìƒ ì ìš©
                    this._gauge.option('title.text', `${value.toFixed(1)} â„ƒ`);
                    this._gauge.option('title.font.color', color);
                }
            }

            // ê²Œì´ì§€ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            gaugeInstances = [];
            $('.gauge').each((i, el) => {
                const letter = String.fromCharCode(65 + i); // A, B, C
                const gauge = new GaugeChart(el, {
                    initialValue: 80,
                    higherValue: 82,
                    title: 'ì¤€ë¹„ ì¤‘',
                }).init();

                if (gauge) {
                    gaugeInstances.push(gauge);
                }
            });

            console.log(`ê²Œì´ì§€ ${gaugeInstances.length}ê°œ ì´ˆê¸°í™” ì™„ë£Œ`);
        }

        // Toast ì´ˆê¸°í™”
        function initializeToast() {
            const btn = document.getElementById("showToastBtn");
            const toastEl = document.getElementById("aiReportToast");
            const toastBody = document.getElementById("toastBody");

            if (btn && toastEl && toastBody && typeof bootstrap !== 'undefined') {
                // íˆ¬ëª…ë„ ì‚­ì œ
                toastEl.style.opacity = "1";
                toastEl.style.backgroundColor = "#ffffff";
                toastEl.style.color = "#000000";

                const toast = new bootstrap.Toast(toastEl, {autohide: false});

                btn.addEventListener("click", function () {
                    toastBody.textContent = "AI ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
                    toast.show();

                    fetch("/ai-summary")
                        .then((res) => res.text())
                        .then((text) => {
                            toastBody.textContent = text;
                            toast.show();
                        })
                        .catch((err) => {
                            toastBody.textContent = "âŒ ë¦¬í¬íŠ¸ ìš”ì²­ ì‹¤íŒ¨";
                            toast.show();
                        });
                });
            }
        }

        // ì œí’ˆë³„ íŒŒì´ ì°¨íŠ¸ìš© ì „ì—­ ë³€ìˆ˜
        const chartMap = {};
        const productStatMap = JSON.parse(localStorage.getItem("productStatMap")) || {};
        const productNames = ['NORMAL', 'BUMP', 'HALF'];

        function initializeProductChart() {
            console.log('ì œí’ˆë³„ íŒŒì´ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘');

            productNames.forEach(name => {
                const ctx = document.getElementById(`chart-${name}`);
                if (!ctx) {
                    console.warn(`chart-${name} ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }

                const chart = new Chart(ctx.getContext("2d"), {
                    type: 'pie',
                    data: {
                        labels: ['ì •ìƒ', 'ë¶ˆëŸ‰'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: ['#75b4ff', '#f8aa70'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            datalabels: {
                                color: '#000',
                                formatter: (value) => value + 'ê°œ',
                                anchor: 'end',
                                align: 'start',
                                offset: 10,
                                font: { weight: 'bold', size: 14 }
                            },
                            title: {
                                display: true,
                                text: name,
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.label}: ${context.parsed}ê°œ`
                                }
                            }
                        }
                    },
                    // ë°ì´í„°ê°€ ì—†ì„ ë•Œ
                    plugins: [{
                        id: 'emptyDataPlugin',
                        beforeDraw: (chart) => {
                            const dataSum = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (dataSum === 0) {
                                const { width, height, ctx } = chart;
                                ctx.save();
                                ctx.font = "26px 'Noto Sans'";
                                ctx.fillStyle = '#999';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText("ì¤€ë¹„ ì¤‘", width / 2, height / 2 + 30);
                                ctx.restore();
                            }
                        }
                    }]
                });

                chartMap[name] = chart;
            });

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            fetch('/api/production/by-product')
                .then(res => res.json())
                .then(data => {
                    data.forEach(({productName, okCount, errorCount, timestamp}) => {
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    });
                }).catch(err => console.error("ì´ˆê¸° ì œí’ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));

            // WebSocket ì—°ê²° ë° êµ¬ë…
            if (typeof Stomp !== 'undefined' && typeof SockJS !== 'undefined') {
                const stomp = Stomp.over(new SockJS("/ws"));
                stomp.connect({}, () => {
                    stomp.subscribe("/topic/product-count", message => {
                        const {productName, okCount, errorCount, timestamp} = JSON.parse(message.body);
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    });

                    for (const [productName, {okCount, errorCount, timestamp}] of Object.entries(productStatMap)) {
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    }
                });
            }
        }

        function updateProductChart(productName, okCount, errorCount, timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            if (
                date.getFullYear() !== today.getFullYear() ||
                date.getMonth() !== today.getMonth() ||
                date.getDate() !== today.getDate()
            ) return;

            productStatMap[productName] = {okCount, errorCount, timestamp};
            localStorage.setItem("productStatMap", JSON.stringify(productStatMap));

            const chart = chartMap[productName];
            if (!chart) return;

            chart.data.datasets[0].data = [okCount, errorCount];
            chart.update();

            // ìˆ˜ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸
            const countDiv = document.getElementById(`count-${productName}`);
            if (countDiv) {
                countDiv.innerText = `ã€ ì •ìƒ: ${okCount}ê°œ | ë¶ˆëŸ‰: ${errorCount}ê°œ ã€‘`;
            }
        }

        // ì—°ê²° ìƒíƒœ ì²´í¬ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
        function checkConnectionStatus() {
            console.log('ì—°ê²° ìƒíƒœ:', {
                webSocketConnected: isConnected,
                temperatureChartsCount: temperatureCharts.length,
                gaugeCount: gaugeInstances.length
            });
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ë””ë²„ê¹…ìš©)
        window.checkConnectionStatus = checkConnectionStatus;
    </script>
</div>
</html>